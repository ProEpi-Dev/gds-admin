import { useEffect, useState } from "react";
import { TrackService } from "../../api/services/track.service";
import { ContentService } from "../../api/services/content.service";
import { formsService } from "../../api/services/forms.service";
import { useNavigate, useParams } from "react-router-dom";
import {
  Box,
  Button,
  TextField,
  Typography,
  FormControlLabel,
  Switch,
  Paper,
  Grid,
  IconButton,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Select,
  MenuItem,
  InputLabel,
  FormControl,
} from "@mui/material";

interface Section {
  id?: number;
  name: string;
  order: number;
  sequences: Sequence[];
}

interface Sequence {
  id?: number;
  content_id?: number;
  form_id?: number;
  order: number;
}

interface Content {
  id: number;
  title: string;
}

interface Form {
  id: number;
  title: string;
}

export default function TrackForm() {
  const { id } = useParams();
  const navigate = useNavigate();
  const snackbar = useSnackbar();
  const isEdit = !!id;

  const [form, setForm] = useState({
    name: "",
    description: "",
    control_period: false,
    start_date: "",
    end_date: "",
    show_after_completion: false,
    sections: [] as Section[],
  });

  const [contents, setContents] = useState<Content[]>([]);
  const [forms, setForms] = useState<Form[]>([]);

  useEffect(() => {
    // Load contents and forms for selection
    ContentService.list().then((res) => setContents(res.data));
    formsService.findAll({ type: 'quiz' }).then((res) => setForms(res.data));

    if (isEdit && id) {
      TrackService.get(Number(id)).then((res) => {
        const track = res.data;
        setForm({
          name: track.name,
          description: track.description || "",
          control_period: track.control_period,
          start_date: track.start_date ? track.start_date.split('T')[0] : "",
          end_date: track.end_date ? track.end_date.split('T')[0] : "",
          show_after_completion: track.show_after_completion,
          sections: track.section || [],
        });
      });
    }
  }, [id, isEdit]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      if (isEdit && id) {
        await TrackService.update(Number(id), form);
        snackbar.showSuccess("Trilha atualizada com sucesso!");
      } else {
        await TrackService.create(form);
        snackbar.showSuccess("Trilha criada com sucesso!");
      }
      navigate("/tracks");
    } catch (error) {
      snackbar.showError("Erro ao salvar trilha");
    }
  };

  const addSection = () => {
    setForm(prev => ({
      ...prev,
      sections: [...prev.sections, {
        name: "",
        order: prev.sections.length,
        sequences: []
      }]
    }));
  };

  const updateSection = (index: number, field: keyof Section, value: any) => {
    setForm(prev => ({
      ...prev,
      sections: prev.sections.map((section, i) =>
        i === index ? { ...section, [field]: value } : section
      )
    }));
  };

  const deleteSection = (index: number) => {
    setForm(prev => ({
      ...prev,
      sections: prev.sections.filter((_, i) => i !== index)
    }));
  };

  const addSequence = (sectionIndex: number) => {
    setForm(prev => ({
      ...prev,
      sections: prev.sections.map((section, i) =>
        i === sectionIndex
          ? {
              ...section,
              sequences: [...section.sequences, {
                order: section.sequences.length
              }]
            }
          : section
      )
    }));
  };

  const updateSequence = (sectionIndex: number, sequenceIndex: number, field: keyof Sequence, value: any) => {
    setForm(prev => ({
      ...prev,
      sections: prev.sections.map((section, i) =>
        i === sectionIndex
          ? {
              ...section,
              sequences: section.sequences.map((seq, j) =>
                j === sequenceIndex ? { ...seq, [field]: value } : seq
              )
            }
          : section
      )
    }));
  };

  const deleteSequence = (sectionIndex: number, sequenceIndex: number) => {
    setForm(prev => ({
      ...prev,
      sections: prev.sections.map((section, i) =>
        i === sectionIndex
          ? {
              ...section,
              sequences: section.sequences.filter((_, j) => j !== sequenceIndex)
            }
          : section
      )
    }));
  };

  return (
    <Box>
        <Box display="flex" alignItems="center" mb={3}>
          <IconButton onClick={() => navigate("/tracks")}>
            <ArrowBackIcon />
          </IconButton>
          <Typography variant="h4" ml={2}>
            {isEdit ? "Editar Trilha" : "Nova Trilha"}
          </Typography>
        </Box>

        <form onSubmit={handleSubmit}>
          <Paper sx={{ p: 3, mb: 3 }}>
            <Typography variant="h6" mb={2}>Informações Gerais</Typography>
            <Grid container spacing={2}>
              <Grid item xs={12} md={6}>
                <TextField
                  fullWidth
                  label="Nome da Trilha"
                  value={form.name}
                  onChange={(e) => setForm(prev => ({ ...prev, name: e.target.value }))}
                  required
                />
              </Grid>
              <Grid item xs={12} md={6}>
                <TextField
                  fullWidth
                  label="Descrição"
                  value={form.description}
                  onChange={(e) => setForm(prev => ({ ...prev, description: e.target.value }))}
                  multiline
                  rows={3}
                />
              </Grid>
              <Grid item xs={12} md={4}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={form.control_period}
                      onChange={(e) => setForm(prev => ({ ...prev, control_period: e.target.checked }))}
                    />
                  }
                  label="Controlar Período"
                />
              </Grid>
              <Grid item xs={12} md={4}>
                <FormControlLabel
                  control={
                    <Switch
                      checked={form.show_after_completion}
                      onChange={(e) => setForm(prev => ({ ...prev, show_after_completion: e.target.checked }))}
                    />
                  }
                  label="Mostrar Após Conclusão"
                />
              </Grid>
            </Grid>

            {form.control_period && (
              <Grid container spacing={2} mt={1}>
                <Grid item xs={12} md={6}>
                  <TextField
                    fullWidth
                    label="Data de Início"
                    type="date"
                    value={form.start_date}
                    onChange={(e) => setForm(prev => ({ ...prev, start_date: e.target.value }))}
                    InputLabelProps={{ shrink: true }}
                  />
                </Grid>
                <Grid item xs={12} md={6}>
                  <TextField
                    fullWidth
                    label="Data de Fim"
                    type="date"
                    value={form.end_date}
                    onChange={(e) => setForm(prev => ({ ...prev, end_date: e.target.value }))}
                    InputLabelProps={{ shrink: true }}
                  />
                </Grid>
              </Grid>
            )}
          </Paper>

          <Paper sx={{ p: 3, mb: 3 }}>
            <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
              <Typography variant="h6">Seções e Sequências</Typography>
              <Button startIcon={<AddIcon />} onClick={addSection} variant="outlined">
                Adicionar Seção
              </Button>
            </Box>

            {form.sections.map((section, sectionIndex) => (
              <Accordion key={sectionIndex} sx={{ mb: 2 }}>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography>{section.name || `Seção ${sectionIndex + 1}`}</Typography>
                  <IconButton
                    onClick={(e) => {
                      e.stopPropagation();
                      deleteSection(sectionIndex);
                    }}
                    color="error"
                    size="small"
                  >
                    <DeleteIcon />
                  </IconButton>
                </AccordionSummary>
                <AccordionDetails>
                  <TextField
                    fullWidth
                    label="Nome da Seção"
                    value={section.name}
                    onChange={(e) => updateSection(sectionIndex, 'name', e.target.value)}
                    sx={{ mb: 2 }}
                  />

                  <Typography variant="subtitle1" mb={1}>Sequências</Typography>
                  <List>
                    {section.sequences.map((sequence, sequenceIndex) => (
                      <ListItem key={sequenceIndex}>
                        <ListItemText>
                          <FormControl fullWidth sx={{ mb: 1 }}>
                            <InputLabel>Tipo</InputLabel>
                            <Select
                              value={sequence.content_id ? 'content' : sequence.form_id ? 'quiz' : ''}
                              onChange={(e) => {
                                if (e.target.value === 'content') {
                                  updateSequence(sectionIndex, sequenceIndex, 'form_id', undefined);
                                } else if (e.target.value === 'quiz') {
                                  updateSequence(sectionIndex, sequenceIndex, 'content_id', undefined);
                                }
                              }}
                            >
                              <MenuItem value="content">Conteúdo</MenuItem>
                              <MenuItem value="quiz">Quiz</MenuItem>
                            </Select>
                          </FormControl>

                          {sequence.content_id === undefined && sequence.form_id === undefined ? (
                            <Typography color="text.secondary">Selecione o tipo</Typography>
                          ) : sequence.content_id !== undefined ? (
                            <FormControl fullWidth>
                              <InputLabel>Conteúdo</InputLabel>
                              <Select
                                value={sequence.content_id || ''}
                                onChange={(e) => updateSequence(sectionIndex, sequenceIndex, 'content_id', Number(e.target.value))}
                              >
                                {contents.map(content => (
                                  <MenuItem key={content.id} value={content.id}>{content.title}</MenuItem>
                                ))}
                              </Select>
                            </FormControl>
                          ) : (
                            <FormControl fullWidth>
                              <InputLabel>Quiz</InputLabel>
                              <Select
                                value={sequence.form_id || ''}
                                onChange={(e) => updateSequence(sectionIndex, sequenceIndex, 'form_id', Number(e.target.value))}
                              >
                                {forms.map(form => (
                                  <MenuItem key={form.id} value={form.title}>{form.title}</MenuItem>
                                ))}
                              </Select>
                            </FormControl>
                          )}
                        </ListItemText>
                        <ListItemSecondaryAction>
                          <IconButton
                            onClick={() => deleteSequence(sectionIndex, sequenceIndex)}
                            color="error"
                          >
                            <DeleteIcon />
                          </IconButton>
                        </ListItemSecondaryAction>
                      </ListItem>
                    ))}
                  </List>

                  <Button
                    startIcon={<AddIcon />}
                    onClick={() => addSequence(sectionIndex)}
                    variant="outlined"
                    size="small"
                  >
                    Adicionar Sequência
                  </Button>
                </AccordionDetails>
              </Accordion>
            ))}
          </Paper>

          <Box display="flex" gap={2}>
            <Button type="submit" variant="contained">
              {isEdit ? "Atualizar" : "Criar"} Trilha
            </Button>
            <Button onClick={() => navigate("/tracks")} variant="outlined">
              Cancelar
            </Button>
          </Box>
        </form>
      </Box>
    </Box>
  );
}