apiVersion: batch/v1
kind: Job
metadata:
  name: database-migration
  namespace: gds
  labels:
    app: database-migration
spec:
  template:
    metadata:
      labels:
        app: database-migration
    spec:
      restartPolicy: OnFailure
      containers:
      - name: flyway
        image: flyway/flyway:9-alpine
        env:
        - name: FLYWAY_URL
          value: jdbc:postgresql://postgres-oltp:5432/app
        - name: FLYWAY_USER
          valueFrom:
            secretKeyRef:
              name: gds-secrets
              key: DB_USER
        - name: FLYWAY_PASSWORD
          valueFrom:
            secretKeyRef:
              name: gds-secrets
              key: DB_PASS
        - name: FLYWAY_LOCATIONS
          value: filesystem:/flyway/sql
        - name: FLYWAY_BASELINE_ON_MIGRATE
          value: "true"
        - name: FLYWAY_VALIDATE_ON_MIGRATE
          value: "false"
        command: ["flyway", "migrate"]
        volumeMounts:
        - name: migration-scripts
          mountPath: /flyway/sql
          readOnly: true
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
      volumes:
      - name: migration-scripts
        configMap:
          name: database-migrations
      initContainers:
      - name: wait-for-database
        image: postgres:15-alpine
        command: ['sh', '-c']
        args:
        - |
          until pg_isready -h postgres-oltp -p 5432 -U $DB_USER -d $DB_NAME; do
            echo "Waiting for database to be ready..."
            sleep 2
          done
          echo "Database is ready!"
        env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: gds-secrets
              key: DB_USER
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: gds-secrets
              key: DB_NAME
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"

    CREATE TABLE "locations" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "name" VARCHAR(255) NOT NULL,
        "type" VARCHAR(50) NOT NULL,
        "level" VARCHAR(50) NOT NULL,
        "country_code" VARCHAR(10),
        "state_code" VARCHAR(10),
        "city_code" VARCHAR(20),
        "latitude" DECIMAL(10, 8),
        "longitude" DECIMAL(11, 8),
        "description" TEXT,
        "is_active" BOOLEAN DEFAULT true,
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
        "updated_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
        "created_by" VARCHAR(255),
        "parent_id" VARCHAR(255),

        CONSTRAINT "locations_pkey" PRIMARY KEY ("id")
    );

    CREATE INDEX "idx_locations_type" ON "locations"("type");
    CREATE INDEX "idx_locations_level" ON "locations"("level");
    CREATE INDEX "idx_locations_country_code" ON "locations"("country_code");
    CREATE INDEX "idx_locations_state_code" ON "locations"("state_code");
    CREATE INDEX "idx_locations_city_code" ON "locations"("city_code");
    CREATE INDEX "idx_locations_parent_id" ON "locations"("parent_id");
    CREATE INDEX "idx_locations_created_by" ON "locations"("created_by");
    CREATE INDEX "idx_locations_is_active" ON "locations"("is_active");

    -- =====================================================
    -- LOCATION HIERARCHY
    -- =====================================================

    CREATE TABLE "location_hierarchy" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "parent_location_id" VARCHAR(255) NOT NULL,
        "child_location_id" VARCHAR(255) NOT NULL,
        "relationship_type" VARCHAR(50) DEFAULT 'contains',
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,

        CONSTRAINT "location_hierarchy_pkey" PRIMARY KEY ("id")
    );

    CREATE UNIQUE INDEX "uq_location_hierarchy_relationship" ON "location_hierarchy"("parent_location_id", "child_location_id");
    CREATE INDEX "idx_location_hierarchy_parent" ON "location_hierarchy"("parent_location_id");
    CREATE INDEX "idx_location_hierarchy_child" ON "location_hierarchy"("child_location_id");
    CREATE INDEX "idx_location_hierarchy_relationship" ON "location_hierarchy"("relationship_type");

    -- =====================================================
    -- LOCATION GEOMETRIES
    -- =====================================================

    CREATE TABLE "location_geometries" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "location_id" VARCHAR(255) NOT NULL,
        "geometry_type" VARCHAR(20) NOT NULL,
        "geometry_data" JSON NOT NULL,
        "name" VARCHAR(255),
        "description" TEXT,
        "is_active" BOOLEAN DEFAULT true,
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
        "created_by" VARCHAR(255),

        CONSTRAINT "location_geometries_pkey" PRIMARY KEY ("id")
    );

    CREATE INDEX "idx_location_geometries_location" ON "location_geometries"("location_id");
    CREATE INDEX "idx_location_geometries_type" ON "location_geometries"("geometry_type");
    CREATE INDEX "idx_location_geometries_is_active" ON "location_geometries"("is_active");
    CREATE INDEX "idx_location_geometries_created_by" ON "location_geometries"("created_by");

    -- =====================================================
    -- SUBMISSION LOCATIONS
    -- =====================================================

    CREATE TABLE "submission_locations" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "submission_id" VARCHAR(255) NOT NULL,
        "location_id" VARCHAR(255) NOT NULL,
        "relationship_type" VARCHAR(50) DEFAULT 'primary',
        "notes" TEXT,
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,

        CONSTRAINT "submission_locations_pkey" PRIMARY KEY ("id")
    );

    CREATE INDEX "idx_submission_locations_submission" ON "submission_locations"("submission_id");
    CREATE INDEX "idx_submission_locations_location" ON "submission_locations"("location_id");
    CREATE INDEX "idx_submission_locations_relationship" ON "submission_locations"("relationship_type");

    -- =====================================================
    -- LOCATION SYNC CACHE
    -- =====================================================

    CREATE TABLE "location_sync_cache" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "location_id" VARCHAR(255) NOT NULL,
        "sync_status" VARCHAR(20) DEFAULT 'pending',
        "last_sync_at" TIMESTAMP(6),
        "sync_data" JSON,
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,

        CONSTRAINT "location_sync_cache_pkey" PRIMARY KEY ("id")
    );

    CREATE INDEX "idx_location_sync_cache_location" ON "location_sync_cache"("location_id");
    CREATE INDEX "idx_location_sync_cache_status" ON "location_sync_cache"("sync_status");

    -- =====================================================
    -- USER LOCATIONS
    -- =====================================================

    CREATE TABLE "user_locations" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "user_id" VARCHAR(255) NOT NULL,
        "location_id" VARCHAR(255) NOT NULL,
        "access_type" VARCHAR(50) DEFAULT 'assigned',
        "include_children" BOOLEAN DEFAULT true,
        "notes" TEXT,
        "is_active" BOOLEAN DEFAULT true,
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
        "created_by" VARCHAR(255),

        CONSTRAINT "user_locations_pkey" PRIMARY KEY ("id")
    );

    CREATE UNIQUE INDEX "uq_user_locations_user_location" ON "user_locations"("user_id", "location_id");
    CREATE INDEX "idx_user_locations_user_id" ON "user_locations"("user_id");
    CREATE INDEX "idx_user_locations_location_id" ON "user_locations"("location_id");
    CREATE INDEX "idx_user_locations_access_type" ON "user_locations"("access_type");
    CREATE INDEX "idx_user_locations_is_active" ON "user_locations"("is_active");
    CREATE INDEX "idx_user_locations_created_by" ON "user_locations"("created_by");

    -- =====================================================
    -- USER LOCATION CACHE
    -- =====================================================

    CREATE TABLE "user_location_cache" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "user_id" VARCHAR(255) NOT NULL,
        "location_id" VARCHAR(255) NOT NULL,
        "cache_type" VARCHAR(50) DEFAULT 'assigned',
        "sync_status" VARCHAR(20) DEFAULT 'pending',
        "last_sync_at" TIMESTAMP(6),
        "cache_data" JSON,
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,

        CONSTRAINT "user_location_cache_pkey" PRIMARY KEY ("id")
    );

    CREATE INDEX "idx_user_location_cache_user_id" ON "user_location_cache"("user_id");
    CREATE INDEX "idx_user_location_cache_location_id" ON "user_location_cache"("location_id");
    CREATE INDEX "idx_user_location_cache_type" ON "user_location_cache"("cache_type");
    CREATE INDEX "idx_user_location_cache_sync_status" ON "user_location_cache"("sync_status");

    -- =====================================================
    -- INCIDENT LOCATIONS
    -- =====================================================

    CREATE TABLE "incident_locations" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "incident_id" VARCHAR(255) NOT NULL,
        "location_id" VARCHAR(255) NOT NULL,
        "relationship_type" VARCHAR(50) DEFAULT 'primary',
        "notes" TEXT,
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,

        CONSTRAINT "incident_locations_pkey" PRIMARY KEY ("id")
    );

    CREATE INDEX "idx_incident_locations_incident" ON "incident_locations"("incident_id");
    CREATE INDEX "idx_incident_locations_location" ON "incident_locations"("location_id");
    CREATE INDEX "idx_incident_locations_relationship" ON "incident_locations"("relationship_type");

    -- =====================================================
    -- INCIDENT CLASSIFICATIONS
    -- =====================================================

    CREATE TABLE "incident_classifications" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "incident_id" VARCHAR(255) NOT NULL,
        "classification_type" VARCHAR(100) NOT NULL,
        "code" VARCHAR(50),
        "description" TEXT NOT NULL,
        "severity_level" VARCHAR(50),
        "confidence_level" VARCHAR(50) DEFAULT 'medium',
        "notes" TEXT,
        "is_final" BOOLEAN DEFAULT false,
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
        "created_by" VARCHAR(255),

        CONSTRAINT "incident_classifications_pkey" PRIMARY KEY ("id")
    );

    CREATE INDEX "idx_incident_classifications_incident_id" ON "incident_classifications"("incident_id");
    CREATE INDEX "idx_incident_classifications_type" ON "incident_classifications"("classification_type");
    CREATE INDEX "idx_incident_classifications_code" ON "incident_classifications"("code");
    CREATE INDEX "idx_incident_classifications_severity" ON "incident_classifications"("severity_level");
    CREATE INDEX "idx_incident_classifications_is_final" ON "incident_classifications"("is_final");
    CREATE INDEX "idx_incident_classifications_created_by" ON "incident_classifications"("created_by");

    -- =====================================================
    -- INCIDENT FINAL REPORTS
    -- =====================================================

    CREATE TABLE "incident_final_reports" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "incident_id" VARCHAR(255) NOT NULL,
        "report_title" VARCHAR(255) NOT NULL,
        "executive_summary" TEXT,
        "investigation_findings" TEXT,
        "root_causes" TEXT,
        "contributing_factors" TEXT,
        "health_impact_assessment" TEXT,
        "recommendations" TEXT,
        "lessons_learned" TEXT,
        "status" VARCHAR(50) DEFAULT 'draft',
        "approved_at" TIMESTAMP(6),
        "approved_by" VARCHAR(255),
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
        "updated_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
        "created_by" VARCHAR(255),
        "updated_by" VARCHAR(255),

        CONSTRAINT "incident_final_reports_pkey" PRIMARY KEY ("id")
    );

    CREATE UNIQUE INDEX "incident_final_reports_incident_id_key" ON "incident_final_reports"("incident_id");
    CREATE INDEX "idx_incident_final_reports_incident_id" ON "incident_final_reports"("incident_id");
    CREATE INDEX "idx_incident_final_reports_status" ON "incident_final_reports"("status");
    CREATE INDEX "idx_incident_final_reports_created_by" ON "incident_final_reports"("created_by");
    CREATE INDEX "idx_incident_final_reports_approved_by" ON "incident_final_reports"("approved_by");

    -- =====================================================
    -- INCIDENT REPORT ATTACHMENTS
    -- =====================================================

    CREATE TABLE "incident_report_attachments" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "report_id" VARCHAR(255) NOT NULL,
        "file_name" VARCHAR(255) NOT NULL,
        "file_type" VARCHAR(100),
        "file_size" INTEGER,
        "file_path" VARCHAR(500),
        "description" TEXT,
        "uploaded_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
        "uploaded_by" VARCHAR(255),
        "org_id" VARCHAR(255) DEFAULT 'org-default',

        CONSTRAINT "incident_report_attachments_pkey" PRIMARY KEY ("id")
    );

    CREATE INDEX "idx_incident_report_attachments_report_id" ON "incident_report_attachments"("report_id");
    CREATE INDEX "idx_incident_report_attachments_uploaded_by" ON "incident_report_attachments"("uploaded_by");
    CREATE INDEX "idx_incident_report_attachments_org_id" ON "incident_report_attachments"("org_id");

    -- =====================================================
    -- INCIDENT RELATIONS
    -- =====================================================

    CREATE TABLE "incident_relations" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "primary_incident_id" VARCHAR(255) NOT NULL,
        "related_incident_id" VARCHAR(255) NOT NULL,
        "relation_type" VARCHAR(50) DEFAULT 'related',
        "notes" TEXT,
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
        "created_by" VARCHAR(255),

        CONSTRAINT "incident_relations_pkey" PRIMARY KEY ("id")
    );

    CREATE UNIQUE INDEX "uq_incident_relations" ON "incident_relations"("primary_incident_id", "related_incident_id");
    CREATE INDEX "idx_incident_relations_created_by" ON "incident_relations"("created_by");
    CREATE INDEX "idx_incident_relations_primary" ON "incident_relations"("primary_incident_id");
    CREATE INDEX "idx_incident_relations_related" ON "incident_relations"("related_incident_id");

    -- =====================================================
    -- INCIDENT SUBMISSIONS
    -- =====================================================

    CREATE TABLE "incident_submissions" (
        "id" VARCHAR(255) NOT NULL DEFAULT (gen_random_uuid())::text,
        "incident_id" VARCHAR(255) NOT NULL,
        "submission_id" VARCHAR(255) NOT NULL,
        "relationship_type" VARCHAR(50) DEFAULT 'source',
        "notes" TEXT,
        "created_at" TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP,
        "created_by" VARCHAR(255),

        CONSTRAINT "incident_submissions_pkey" PRIMARY KEY ("id")
    );

    CREATE UNIQUE INDEX "uq_incident_submissions" ON "incident_submissions"("incident_id", "submission_id");
    CREATE INDEX "idx_incident_submissions_created_by" ON "incident_submissions"("created_by");
    CREATE INDEX "idx_incident_submissions_incident" ON "incident_submissions"("incident_id");
    CREATE INDEX "idx_incident_submissions_submission" ON "incident_submissions"("submission_id");
    CREATE INDEX "idx_incident_submissions_relationship_type" ON "incident_submissions"("relationship_type");

    -- Flyway Schema History é criada automaticamente pelo Flyway

    -- =====================================================
    -- FOREIGN KEY CONSTRAINTS
    -- =====================================================

    -- Organizations
    ALTER TABLE "persons" ADD CONSTRAINT "fk_persons_org_id" 
        FOREIGN KEY ("org_id") REFERENCES "organizations"("id") ON DELETE SET NULL ON UPDATE NO ACTION;

    -- Forms
    ALTER TABLE "forms" ADD CONSTRAINT "fk_forms_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "forms" ADD CONSTRAINT "fk_forms_updated_by" 
        FOREIGN KEY ("updated_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "forms" ADD CONSTRAINT "fk_forms_org_id" 
        FOREIGN KEY ("org_id") REFERENCES "organizations"("id") ON DELETE SET NULL ON UPDATE NO ACTION;

    -- Form Versions
    ALTER TABLE "form_versions" ADD CONSTRAINT "fk_form_versions_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "form_versions" ADD CONSTRAINT "fk_form_versions_form" 
        FOREIGN KEY ("form_id") REFERENCES "forms"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- Submissions
    ALTER TABLE "submissions" ADD CONSTRAINT "fk_submissions_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "submissions" ADD CONSTRAINT "fk_submissions_updated_by" 
        FOREIGN KEY ("updated_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "submissions" ADD CONSTRAINT "fk_submissions_form_id" 
        FOREIGN KEY ("form_id") REFERENCES "forms"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
    ALTER TABLE "submissions" ADD CONSTRAINT "fk_submissions_org_id" 
        FOREIGN KEY ("org_id") REFERENCES "organizations"("id") ON DELETE SET NULL ON UPDATE NO ACTION;

    -- Incidents
    ALTER TABLE "incidents" ADD CONSTRAINT "fk_incidents_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "incidents" ADD CONSTRAINT "fk_incidents_updated_by" 
        FOREIGN KEY ("updated_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "incidents" ADD CONSTRAINT "fk_incidents_org_id" 
        FOREIGN KEY ("org_id") REFERENCES "organizations"("id") ON DELETE SET NULL ON UPDATE NO ACTION;

    -- Follow Ups
    ALTER TABLE "follow_ups" ADD CONSTRAINT "fk_follow_ups_assigned_to" 
        FOREIGN KEY ("assigned_to") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "follow_ups" ADD CONSTRAINT "fk_follow_ups_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "follow_ups" ADD CONSTRAINT "fk_follow_ups_updated_by" 
        FOREIGN KEY ("updated_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "follow_ups" ADD CONSTRAINT "fk_follow_ups_incident_id" 
        FOREIGN KEY ("incident_id") REFERENCES "incidents"("id") ON DELETE CASCADE ON UPDATE NO ACTION;
    ALTER TABLE "follow_ups" ADD CONSTRAINT "fk_follow_ups_submission_id" 
        FOREIGN KEY ("submission_id") REFERENCES "submissions"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- Dashboards
    ALTER TABLE "dashboards" ADD CONSTRAINT "fk_dashboards_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "dashboards" ADD CONSTRAINT "fk_dashboards_updated_by" 
        FOREIGN KEY ("updated_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;

    -- Locations
    ALTER TABLE "locations" ADD CONSTRAINT "fk_locations_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "locations" ADD CONSTRAINT "fk_locations_parent" 
        FOREIGN KEY ("parent_id") REFERENCES "locations"("id") ON DELETE SET NULL ON UPDATE NO ACTION;

    -- Location Hierarchy
    ALTER TABLE "location_hierarchy" ADD CONSTRAINT "fk_location_hierarchy_parent" 
        FOREIGN KEY ("parent_location_id") REFERENCES "locations"("id") ON DELETE CASCADE ON UPDATE NO ACTION;
    ALTER TABLE "location_hierarchy" ADD CONSTRAINT "fk_location_hierarchy_child" 
        FOREIGN KEY ("child_location_id") REFERENCES "locations"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- Location Geometries
    ALTER TABLE "location_geometries" ADD CONSTRAINT "fk_location_geometries_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "location_geometries" ADD CONSTRAINT "fk_location_geometries_location" 
        FOREIGN KEY ("location_id") REFERENCES "locations"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- Submission Locations
    ALTER TABLE "submission_locations" ADD CONSTRAINT "fk_submission_locations_submission" 
        FOREIGN KEY ("submission_id") REFERENCES "submissions"("id") ON DELETE CASCADE ON UPDATE NO ACTION;
    ALTER TABLE "submission_locations" ADD CONSTRAINT "fk_submission_locations_location" 
        FOREIGN KEY ("location_id") REFERENCES "locations"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- Location Sync Cache
    ALTER TABLE "location_sync_cache" ADD CONSTRAINT "fk_location_sync_cache_location" 
        FOREIGN KEY ("location_id") REFERENCES "locations"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- User Locations
    ALTER TABLE "user_locations" ADD CONSTRAINT "fk_user_locations_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "user_locations" ADD CONSTRAINT "fk_user_locations_location" 
        FOREIGN KEY ("location_id") REFERENCES "locations"("id") ON DELETE CASCADE ON UPDATE NO ACTION;
    ALTER TABLE "user_locations" ADD CONSTRAINT "fk_user_locations_user" 
        FOREIGN KEY ("user_id") REFERENCES "persons"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- User Location Cache
    ALTER TABLE "user_location_cache" ADD CONSTRAINT "fk_user_location_cache_location" 
        FOREIGN KEY ("location_id") REFERENCES "locations"("id") ON DELETE CASCADE ON UPDATE NO ACTION;
    ALTER TABLE "user_location_cache" ADD CONSTRAINT "fk_user_location_cache_user" 
        FOREIGN KEY ("user_id") REFERENCES "persons"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- Incident Locations
    ALTER TABLE "incident_locations" ADD CONSTRAINT "fk_incident_locations_incident" 
        FOREIGN KEY ("incident_id") REFERENCES "incidents"("id") ON DELETE CASCADE ON UPDATE NO ACTION;
    ALTER TABLE "incident_locations" ADD CONSTRAINT "fk_incident_locations_location" 
        FOREIGN KEY ("location_id") REFERENCES "locations"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- Incident Classifications
    ALTER TABLE "incident_classifications" ADD CONSTRAINT "fk_incident_classifications_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "incident_classifications" ADD CONSTRAINT "fk_incident_classifications_incident" 
        FOREIGN KEY ("incident_id") REFERENCES "incidents"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- Incident Final Reports
    ALTER TABLE "incident_final_reports" ADD CONSTRAINT "fk_incident_final_reports_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "incident_final_reports" ADD CONSTRAINT "fk_incident_final_reports_updated_by" 
        FOREIGN KEY ("updated_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "incident_final_reports" ADD CONSTRAINT "fk_incident_final_reports_approved_by" 
        FOREIGN KEY ("approved_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "incident_final_reports" ADD CONSTRAINT "fk_incident_final_reports_incident" 
        FOREIGN KEY ("incident_id") REFERENCES "incidents"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- Incident Report Attachments
    ALTER TABLE "incident_report_attachments" ADD CONSTRAINT "fk_incident_report_attachments_uploaded_by" 
        FOREIGN KEY ("uploaded_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "incident_report_attachments" ADD CONSTRAINT "fk_incident_report_attachments_report" 
        FOREIGN KEY ("report_id") REFERENCES "incident_final_reports"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- Incident Relations
    ALTER TABLE "incident_relations" ADD CONSTRAINT "fk_incident_relations_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "incident_relations" ADD CONSTRAINT "fk_incident_relations_primary_incident" 
        FOREIGN KEY ("primary_incident_id") REFERENCES "incidents"("id") ON DELETE CASCADE ON UPDATE NO ACTION;
    ALTER TABLE "incident_relations" ADD CONSTRAINT "fk_incident_relations_related_incident" 
        FOREIGN KEY ("related_incident_id") REFERENCES "incidents"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- Incident Submissions
    ALTER TABLE "incident_submissions" ADD CONSTRAINT "fk_incident_submissions_created_by" 
        FOREIGN KEY ("created_by") REFERENCES "persons"("id") ON DELETE SET NULL ON UPDATE NO ACTION;
    ALTER TABLE "incident_submissions" ADD CONSTRAINT "fk_incident_submissions_incident" 
        FOREIGN KEY ("incident_id") REFERENCES "incidents"("id") ON DELETE CASCADE ON UPDATE NO ACTION;
    ALTER TABLE "incident_submissions" ADD CONSTRAINT "fk_incident_submissions_submission" 
        FOREIGN KEY ("submission_id") REFERENCES "submissions"("id") ON DELETE CASCADE ON UPDATE NO ACTION;

    -- =====================================================
    -- SAMPLE DATA
    -- =====================================================

    -- Insert default organization
    INSERT INTO organizations (id, name, code, description, active) 
    VALUES ('org-default', 'Organização Padrão', 'DEFAULT', 'Organização padrão do sistema', true)
    ON CONFLICT (id) DO NOTHING;

  # V2__Insert_admin_user.sql
  V2__Insert_admin_user.sql: |
    -- V2: Insert admin user
    -- Creates the default admin user for the system

    INSERT INTO persons (id, name, email, external_id, role, first_name, last_name, active, org_id) 
    VALUES (
        'admin-user-001',
        'Administrador do Sistema',
        'admin@gds.com',
        'admin-keycloak-id',
        'admin',
        'Admin',
        'Sistema',
        true,
        'org-default'
    )
    ON CONFLICT (email) DO NOTHING;
