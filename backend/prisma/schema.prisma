generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model context {
  id              Int                 @id @default(autoincrement())
  location_id     Int?
  name            String              @db.VarChar(255)
  description     String?
  type            String?             @db.VarChar(255)
  access_type     context_access_type
  created_at      DateTime            @default(now()) @db.Timestamp(6)
  updated_at      DateTime            @default(now()) @db.Timestamp(6)
  active          Boolean             @default(true)
  content         content[]
  location        location?           @relation(fields: [location_id], references: [id], onUpdate: NoAction)
  context_manager context_manager[]
  form            form[]
  participation   participation[]
  track           track[]

  @@index([location_id], map: "idx_context_location_id")
}

model context_manager {
  id         Int      @id @default(autoincrement())
  user_id    Int
  context_id Int
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)
  active     Boolean  @default(true)
  context    context  @relation(fields: [context_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user       user     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, context_id])
  @@index([context_id], map: "idx_context_manager_context_id")
  @@index([user_id], map: "idx_context_manager_user_id")
}

model flyway_schema_history {
  installed_rank Int      @id(map: "flyway_schema_history_pk")
  version        String?  @db.VarChar(50)
  description    String   @db.VarChar(200)
  type           String   @db.VarChar(20)
  script         String   @db.VarChar(1000)
  checksum       Int?
  installed_by   String   @db.VarChar(100)
  installed_on   DateTime @default(now()) @db.Timestamp(6)
  execution_time Int
  success        Boolean

  @@index([success], map: "flyway_schema_history_s_idx")
}

model form {
  id           Int            @id @default(autoincrement())
  context_id   Int?
  title        String         @db.VarChar(255)
  reference    String?        @db.VarChar(255)
  description  String?
  type         form_type_enum
  created_at   DateTime       @default(now()) @db.Timestamp(6)
  updated_at   DateTime       @default(now()) @db.Timestamp(6)
  active       Boolean        @default(true)
  context      context?       @relation(fields: [context_id], references: [id], onUpdate: NoAction)
  form_version form_version[]
  content_quiz content_quiz[]
  sequence     sequence[]

  @@index([context_id], map: "idx_form_context_id")
}

model form_version {
  id                  Int                      @id @default(autoincrement())
  form_id             Int
  version_number       Int
  definition           Json
  access_type          form_version_access_type
  passing_score        Decimal?                 @db.Decimal(5, 2)
  max_attempts         Int?
  time_limit_minutes  Int?
  show_feedback        Boolean                  @default(true)
  randomize_questions  Boolean                  @default(false)
  created_at           DateTime                 @default(now()) @db.Timestamp(6)
  updated_at           DateTime                 @default(now()) @db.Timestamp(6)
  active               Boolean                  @default(true)
  form                 form                     @relation(fields: [form_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  report               report[]
  quiz_submission      quiz_submission[]

  @@unique([form_id, version_number])
  @@index([form_id], map: "idx_form_version_form_id")
}

model location {
  id             Int        @id @default(autoincrement())
  parent_id      Int?
  name           String     @db.VarChar(255)
  latitude       Decimal?   @db.Decimal(10, 8)
  longitude      Decimal?   @db.Decimal(11, 8)
  polygons       Json?
  created_at     DateTime   @default(now()) @db.Timestamp(6)
  updated_at     DateTime   @default(now()) @db.Timestamp(6)
  active         Boolean    @default(true)
  context        context[]
  location       location?  @relation("locationTolocation", fields: [parent_id], references: [id], onUpdate: NoAction)
  other_location location[] @relation("locationTolocation")
  user           user[]

  @@index([parent_id], map: "idx_location_parent_id")
}

model participation {
  id              Int               @id @default(autoincrement())
  user_id         Int
  context_id       Int
  start_date       DateTime          @db.Date
  end_date         DateTime?         @db.Date
  active           Boolean           @default(true)
  created_at       DateTime          @default(now()) @db.Timestamp(6)
  updated_at       DateTime          @default(now()) @db.Timestamp(6)
  context          context           @relation(fields: [context_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user             user              @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  report           report[]
  quiz_submission  quiz_submission[]

  @@index([context_id], map: "idx_participation_context_id")
  @@index([user_id], map: "idx_participation_user_id")
}

model report {
  id                  Int              @id @default(autoincrement())
  participation_id    Int
  report_type         report_type_enum
  occurrence_location Json?
  form_version_id     Int
  form_response       Json
  created_at          DateTime         @default(now()) @db.Timestamp(6)
  updated_at          DateTime         @default(now()) @db.Timestamp(6)
  active              Boolean          @default(true)
  form_version        form_version     @relation(fields: [form_version_id], references: [id], onUpdate: NoAction)
  participation       participation    @relation(fields: [participation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([form_version_id], map: "idx_report_form_version_id")
  @@index([participation_id], map: "idx_report_participation_id")
}

model user {
  id                    Int                     @id @default(autoincrement())
  name                  String                  @db.VarChar(255)
  email                 String                  @unique @db.VarChar(255)
  password              String                  @db.VarChar(255)
  gender_id             Int?
  location_id           Int?
  external_identifier   String?                 @db.VarChar(100)
  created_at            DateTime                @default(now()) @db.Timestamp(6)
  updated_at            DateTime                @default(now()) @db.Timestamp(6)
  active                Boolean                 @default(true)
  content               content[]
  context_manager       context_manager[]
  participation         participation[]
  gender                gender?                 @relation(fields: [gender_id], references: [id], onUpdate: NoAction)
  location              location?               @relation(fields: [location_id], references: [id], onUpdate: NoAction)
  user_legal_acceptance user_legal_acceptance[]

  @@index([email], map: "idx_user_email")
  @@index([gender_id], map: "idx_user_gender_id")
  @@index([location_id], map: "idx_user_location_id")
  @@index([external_identifier], map: "idx_user_external_identifier")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model content {
  id           Int           @id @default(autoincrement())
  title        String        @db.VarChar(200)
  reference    String        @unique(map: "uq_content_reference") @db.VarChar(50)
  content      String
  active       Boolean       @default(false)
  summary      String?       @db.VarChar(500)
  slug         String        @unique(map: "uq_content_slug") @db.VarChar(255)
  author_id    Int
  context_id   Int?
  created_at   DateTime      @default(now()) @db.Timestamp(6)
  updated_at   DateTime      @default(now()) @db.Timestamp(6)
  published_at DateTime?     @db.Timestamp(6)
  user         user          @relation(fields: [author_id], references: [id], onUpdate: NoAction)
  context      context?      @relation(fields: [context_id], references: [id], onUpdate: NoAction)
  content_tag  content_tag[]
  content_quiz content_quiz[]
  sequence     sequence[]

  @@index([active], map: "idx_content_active")
  @@index([author_id], map: "idx_content_author_id")
  @@index([context_id], map: "idx_content_context_id")
  @@index([created_at], map: "idx_content_created_at")
  @@index([reference], map: "idx_content_reference")
  @@index([slug], map: "idx_content_slug_idx")
  @@index([title], map: "idx_content_title")
}

model content_tag {
  id         Int      @id @default(autoincrement())
  content_id Int
  tag_id     Int
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)
  active     Boolean  @default(true)
  content    content  @relation(fields: [content_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tag        tag      @relation(fields: [tag_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([content_id, tag_id], map: "uq_content_tag_unique")
  @@index([content_id], map: "idx_content_tag_content_id")
  @@index([tag_id], map: "idx_content_tag_tag_id")
}

model tag {
  id          Int           @id @default(autoincrement())
  name        String        @unique(map: "uq_tag_name") @db.VarChar(100)
  color       String?       @db.VarChar(7)
  description String?       @db.VarChar(255)
  created_at  DateTime      @default(now()) @db.Timestamp(6)
  updated_at  DateTime      @default(now()) @db.Timestamp(6)
  active      Boolean       @default(true)
  content_tag content_tag[]

  @@index([name], map: "idx_tag_name_idx")
}

enum context_access_type {
  PUBLIC
  PRIVATE
}

enum form_type_enum {
  signal
  quiz
}

enum form_version_access_type {
  PUBLIC
  PRIVATE
}

enum report_type_enum {
  POSITIVE
  NEGATIVE
}

model gender {
  id         Int      @id @default(autoincrement())
  name       String   @unique @db.VarChar(50)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)
  active     Boolean  @default(true)
  user       user[]

  @@index([name], map: "idx_gender_name")
}

model legal_document_type {
  id             Int              @id @default(autoincrement())
  code           String           @unique @db.VarChar(50)
  name           String           @db.VarChar(100)
  description    String?
  is_required    Boolean          @default(true)
  created_at     DateTime         @default(now()) @db.Timestamp(6)
  updated_at     DateTime         @default(now()) @db.Timestamp(6)
  active         Boolean          @default(true)
  legal_document legal_document[]

  @@index([code], map: "idx_legal_document_type_code")
  @@index([active], map: "idx_legal_document_type_active")
}

model legal_document {
  id                     Int                     @id @default(autoincrement())
  type_id                Int
  version                String                  @db.VarChar(20)
  title                  String                  @db.VarChar(255)
  content                String
  effective_date         DateTime                @db.Date
  created_at             DateTime                @default(now()) @db.Timestamp(6)
  updated_at             DateTime                @default(now()) @db.Timestamp(6)
  active                 Boolean                 @default(true)
  legal_document_type    legal_document_type     @relation(fields: [type_id], references: [id], onDelete: Restrict, onUpdate: NoAction)
  user_legal_acceptance  user_legal_acceptance[]

  @@unique([type_id, version])
  @@index([type_id], map: "idx_legal_document_type_id")
  @@index([active], map: "idx_legal_document_active")
  @@index([effective_date], map: "idx_legal_document_effective_date")
}

model user_legal_acceptance {
  id                 Int            @id @default(autoincrement())
  user_id            Int
  legal_document_id  Int
  accepted_at        DateTime       @default(now()) @db.Timestamp(6)
  ip_address         String?        @db.VarChar(45)
  user_agent         String?
  user               user           @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  legal_document     legal_document @relation(fields: [legal_document_id], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@unique([user_id, legal_document_id])
  @@index([user_id], map: "idx_user_legal_acceptance_user_id")
  @@index([legal_document_id], map: "idx_user_legal_acceptance_document_id")
  @@index([accepted_at], map: "idx_user_legal_acceptance_accepted_at")
}

model content_quiz {
  id           Int      @id @default(autoincrement())
  content_id   Int
  form_id      Int
  display_order Int     @default(0)
  is_required  Boolean  @default(false)
  weight       Decimal  @default(1.0) @db.Decimal(5, 2)
  created_at   DateTime @default(now()) @db.Timestamp(6)
  updated_at   DateTime @default(now()) @db.Timestamp(6)
  active       Boolean  @default(true)
  content      content  @relation(fields: [content_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  form         form     @relation(fields: [form_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([content_id, form_id], map: "uq_content_quiz_unique")
  @@index([content_id], map: "idx_content_quiz_content_id")
  @@index([form_id], map: "idx_content_quiz_form_id")
  @@index([content_id, display_order], map: "idx_content_quiz_display_order")
}

model quiz_submission {
  id                 Int            @id @default(autoincrement())
  participation_id   Int
  form_version_id     Int
  quiz_response       Json
  question_results    Json?         // Resultados detalhados por quest√£o: [{questionName, isCorrect, pointsEarned, userAnswer, correctAnswer, feedback}]
  score              Decimal?       @db.Decimal(5, 2)
  percentage         Decimal?       @db.Decimal(5, 2)
  is_passed          Boolean?
  attempt_number     Int
  time_spent_seconds Int?
  started_at         DateTime       @db.Timestamp(6)
  completed_at       DateTime?      @db.Timestamp(6)
  created_at         DateTime       @default(now()) @db.Timestamp(6)
  updated_at         DateTime       @default(now()) @db.Timestamp(6)
  active             Boolean        @default(true)
  participation      participation  @relation(fields: [participation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  form_version       form_version   @relation(fields: [form_version_id], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@index([participation_id], map: "idx_quiz_submission_participation_id")
  @@index([form_version_id], map: "idx_quiz_submission_form_version_id")
  @@index([score], map: "idx_quiz_submission_score")
  @@index([is_passed], map: "idx_quiz_submission_is_passed")
  @@index([participation_id, form_version_id, attempt_number], map: "idx_quiz_submission_attempt")
  @@index([completed_at], map: "idx_quiz_submission_completed_at")
}

model track {
  id                    Int       @id @default(autoincrement())
  name                  String    @db.VarChar(255)
  description           String?
  context_id            Int?
  control_period        Boolean   @default(false)
  start_date            DateTime? @db.Date
  end_date              DateTime? @db.Date
  show_after_completion Boolean   @default(false)
  has_progression       Boolean   @default(false)
  created_at            DateTime  @default(now()) @db.Timestamp(6)
  updated_at            DateTime  @default(now()) @db.Timestamp(6)
  active                Boolean   @default(true)
  context               context?  @relation(fields: [context_id], references: [id], onUpdate: NoAction)
  section               section[]

  @@index([context_id], map: "idx_track_context_id")
  @@index([active], map: "idx_track_active")
}

model section {
  id         Int       @id @default(autoincrement())
  track_id   Int
  name       String    @db.VarChar(255)
  order      Int       @default(0)
  created_at DateTime  @default(now()) @db.Timestamp(6)
  updated_at DateTime  @default(now()) @db.Timestamp(6)
  active     Boolean   @default(true)
  track      track     @relation(fields: [track_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sequence   sequence[]

  @@index([track_id], map: "idx_section_track_id")
  @@index([order], map: "idx_section_order")
}

model sequence {
  id         Int       @id @default(autoincrement())
  section_id Int
  content_id Int?
  form_id    Int?      // Quiz
  order      Int       @default(0)
  created_at DateTime  @default(now()) @db.Timestamp(6)
  updated_at DateTime  @default(now()) @db.Timestamp(6)
  active     Boolean   @default(true)
  section    section   @relation(fields: [section_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  content    content?  @relation(fields: [content_id], references: [id], onUpdate: NoAction)
  form       form?     @relation(fields: [form_id], references: [id], onUpdate: NoAction)

  @@index([section_id], map: "idx_sequence_section_id")
  @@index([content_id], map: "idx_sequence_content_id")
  @@index([form_id], map: "idx_sequence_form_id")
  @@index([order], map: "idx_sequence_order")
}
