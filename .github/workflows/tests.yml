name: ðŸ§ª Unit Tests

on:
  push:
    branches-ignore: [ main ]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/tests.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/tests.yml"

jobs:
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Detect changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  test-backend:
    name: ðŸ§ª Backend Unit Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: backend/yarn.lock

      - name: ðŸ“¥ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ðŸ”§ Generate Prisma Client
        run: yarn prisma generate

      - name: ðŸ§ª Run tests with coverage
        id: test
        run: yarn test:cov

      - name: ðŸ“Š Extract coverage percentage
        id: coverage
        run: |
          # Extrair a porcentagem de cobertura do relatÃ³rio do Jest usando Node.js
          COVERAGE=$(node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8')); console.log(data.total.lines.pct.toFixed(2));")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Cobertura de cÃ³digo: ${COVERAGE}%"

      - name: âœ… Check coverage threshold
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          MIN_COVERAGE=90
          
          echo "ðŸ“Š Cobertura atual: ${COVERAGE}%"
          echo "ðŸŽ¯ Cobertura mÃ­nima exigida: ${MIN_COVERAGE}%"
          
          # Comparar usando Node.js para suportar nÃºmeros decimais
          node -e "const coverage = parseFloat('$COVERAGE'); const min = parseFloat('$MIN_COVERAGE'); process.exit(coverage < min ? 1 : 0);"
          
          if [ $? -ne 0 ]; then
            echo "âŒ Cobertura de cÃ³digo (${COVERAGE}%) estÃ¡ abaixo do mÃ­nimo exigido (${MIN_COVERAGE}%)"
            exit 1
          else
            echo "âœ… Cobertura de cÃ³digo (${COVERAGE}%) atende ao mÃ­nimo exigido (${MIN_COVERAGE}%)"
          fi

      - name: ðŸ“¤ Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage-report
          path: backend/coverage/
          retention-days: 7

      - name: ðŸ“¢ Coverage Summary
        if: always()
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          MIN_COVERAGE=90
          
          echo "### ðŸ§ª Resultados dos Testes UnitÃ¡rios - Backend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“Š Cobertura de CÃ³digo" >> $GITHUB_STEP_SUMMARY
          echo "- **Cobertura Atual:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Cobertura MÃ­nima Exigida:** ${MIN_COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verificar se a cobertura atende ao mÃ­nimo usando Node.js
          STATUS=$(node -e "const coverage = parseFloat('$COVERAGE'); const min = parseFloat('$MIN_COVERAGE'); console.log(coverage < min ? 'FAIL' : 'PASS');")
          
          if [ "$STATUS" = "FAIL" ]; then
            echo "âŒ **Status:** Cobertura abaixo do mÃ­nimo exigido" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Por favor, adicione mais testes para atingir pelo menos ${MIN_COVERAGE}% de cobertura." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Status:** Cobertura atende ao mÃ­nimo exigido" >> $GITHUB_STEP_SUMMARY
          fi

  # TODO: Adicionar job test-frontend quando os testes estiverem implementados
  # test-frontend:
  #   name: ðŸ§ª Frontend Unit Tests
  #   runs-on: ubuntu-latest
  #   ...

