name: ðŸš€ Build and Deploy

on:
  push:
    branches: [ main ]
    paths-ignore:
      - "k8s/**"
      - "**/README.md"
      - "**/*.md"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: proepi-dev/gds-admin

jobs:
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ” Detect changes
      id: changes
      run: |
        # Se for workflow_dispatch, builda tudo
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "backend=true" >> $GITHUB_OUTPUT
          echo "frontend=true" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Workflow manual dispatch - building all components"
          exit 0
        fi
        
        # Para push direto, comparar com commit anterior
        BASE_SHA=$(git rev-parse HEAD~1)
        
        echo "Base SHA: $BASE_SHA"
        echo "Current SHA: ${{ github.sha }}"
        
        # Verificar mudanÃ§as em cada pasta
        # git diff --quiet retorna 0 se NÃƒO hÃ¡ diferenÃ§as, entÃ£o invertemos a lÃ³gica
        if git diff --quiet $BASE_SHA..${{ github.sha }} -- backend/; then
          echo "backend=false" >> $GITHUB_OUTPUT
        else
          echo "backend=true" >> $GITHUB_OUTPUT
        fi
        
        if git diff --quiet $BASE_SHA..${{ github.sha }} -- frontend/; then
          echo "frontend=false" >> $GITHUB_OUTPUT
        else
          echo "frontend=true" >> $GITHUB_OUTPUT
        fi
        
        echo "ðŸ“Š Changes detected:"
        echo "  Backend: $(grep backend $GITHUB_OUTPUT | cut -d= -f2)"
        echo "  Frontend: $(grep frontend $GITHUB_OUTPUT | cut -d= -f2)"

    - name: ðŸ“¢ Show detected changes
      run: |
        echo "### ðŸ“Š Change Detection Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend:** ${{ steps.changes.outputs.backend == 'true' && 'âœ… Changed' || 'â­ï¸ No changes' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend:** ${{ steps.changes.outputs.frontend == 'true' && 'âœ… Changed' || 'â­ï¸ No changes' }}" >> $GITHUB_STEP_SUMMARY

  build-backend:
    name: ðŸ—ï¸ Build Backend
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“… Generate timestamp
        id: timestamp
        run: echo "date=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

      - name: ðŸ·ï¸ Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ steps.timestamp.outputs.date }}

      - name: ðŸ—ï¸ Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    name: ðŸŽ¨ Build Frontend
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Setup environment variables
        run: |
          cd frontend
          
          echo "ðŸ”§ Configurando ambiente..."
          
          if [ ! -f ".env.production" ]; then
            echo "âŒ Arquivo .env.production nÃ£o encontrado!"
            echo "ðŸ“ Criando arquivo com configuraÃ§Ã£o padrÃ£o..."
            echo "VITE_API_BASE_URL=https://devapi.gds.proepi.org.br/v1" > .env.production
          fi
          
          echo "âœ… Ambiente configurado!"
          echo "ðŸ“„ ConteÃºdo do .env.production:"
          cat .env.production

      - name: ðŸ“… Generate timestamp
        id: timestamp
        run: echo "date=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

      - name: ðŸ·ï¸ Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ steps.timestamp.outputs.date }}

      - name: ðŸ—ï¸ Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-backend:
    name: ðŸš€ Deploy Backend
    needs: [detect-changes, build-backend]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.detect-changes.outputs.backend == 'true' &&
      needs.build-backend.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: ðŸ” Configure kubectl
      run: |
        # Decode base64 to YAML
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig.yaml
        
        # Test connection
        export KUBECONFIG=kubeconfig.yaml
        kubectl cluster-info

    - name: ðŸ”„ Sync database migrations
      run: |
        export KUBECONFIG=kubeconfig.yaml
        
        # Sync migrations to ConfigMap
        if [ -f k8s/sync-migrations.sh ]; then
          chmod +x k8s/sync-migrations.sh
          ./k8s/sync-migrations.sh
        fi

    - name: ðŸ—„ï¸ Run database migrations
      run: |
        export KUBECONFIG=kubeconfig.yaml
        
        # Apply migration job
        kubectl apply -f k8s/database-migration-job.yaml -n gds
        
        # Wait for migration to complete (with timeout)
        kubectl wait --for=condition=complete job/database-migration -n gds --timeout=300s || true
        
        # Show migration logs
        kubectl logs -l job-name=database-migration -n gds --tail=50 || true
        
        # Clean up job
        kubectl delete job database-migration -n gds --ignore-not-found=true

    - name: ðŸš€ Deploy Backend
      run: |
        export KUBECONFIG=kubeconfig.yaml
        
        echo "ðŸ”„ Restarting backend deployment..."
        kubectl rollout restart deployment/gds-backend -n gds
        
        echo "â³ Waiting for rollout to complete..."
        kubectl rollout status deployment/gds-backend -n gds --timeout=300s

    - name: âœ… Verify backend deployment
      run: |
        export KUBECONFIG=kubeconfig.yaml
        
        echo "ðŸ“‹ Backend pods status:"
        kubectl get pods -l app=gds-backend -n gds
        echo ""
        echo "ðŸŒ Backend service:"
        kubectl get svc gds-backend -n gds || true

  deploy-frontend:
    name: ðŸŽ¨ Deploy Frontend
    needs: [detect-changes, build-frontend]
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.detect-changes.outputs.frontend == 'true' &&
      needs.build-frontend.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: ðŸ” Configure kubectl
      run: |
        # Decode base64 to YAML
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig.yaml
        
        # Test connection
        export KUBECONFIG=kubeconfig.yaml
        kubectl cluster-info

    - name: ðŸŽ¨ Deploy Frontend
      run: |
        export KUBECONFIG=kubeconfig.yaml
        
        echo "ðŸ”„ Restarting frontend deployment..."
        kubectl rollout restart deployment/gds-frontend -n gds
        
        echo "â³ Waiting for rollout to complete..."
        kubectl rollout status deployment/gds-frontend -n gds --timeout=300s

    - name: âœ… Verify frontend deployment
      run: |
        export KUBECONFIG=kubeconfig.yaml
        
        echo "ðŸ“‹ Frontend pods status:"
        kubectl get pods -l app=gds-frontend -n gds
        echo ""
        echo "ðŸŒ Frontend service:"
        kubectl get svc gds-frontend -n gds || true

  verify-deployment:
    name: âœ… Verify Deployment
    needs: [deploy-backend, deploy-frontend]
    if: |
      always() &&
      (needs.deploy-backend.result == 'success' || needs.deploy-frontend.result == 'success')
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: ðŸ” Configure kubectl
      run: |
        # Decode base64 to YAML
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig.yaml
        
        # Test connection
        export KUBECONFIG=kubeconfig.yaml
        kubectl cluster-info

    - name: âœ… Verify deployment
      run: |
        export KUBECONFIG=kubeconfig.yaml
        
        echo "ðŸ“‹ Deployment status:"
        kubectl get pods -n gds
        echo ""
        echo "ðŸŒ Services:"
        kubectl get svc -n gds
        echo ""
        echo "ðŸ”— Ingress:"
        kubectl get ingress -n gds

  notify:
    name: ðŸ“¢ Notify Results
    needs: [detect-changes, build-backend, build-frontend, deploy-backend, deploy-frontend, verify-deployment]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š Generate Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Changes Detected" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend:** ${{ needs.detect-changes.outputs.backend == 'true' && 'âœ… Changed' || 'â­ï¸ No changes' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend:** ${{ needs.detect-changes.outputs.frontend == 'true' && 'âœ… Changed' || 'â­ï¸ No changes' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ—ï¸ Build Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend Build:** ${{ needs.build-backend.result == 'success' && 'âœ… Success' || needs.build-backend.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Build:** ${{ needs.build-frontend.result == 'success' && 'âœ… Success' || needs.build-frontend.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend Deploy:** ${{ needs.deploy-backend.result == 'success' && 'âœ… Success' || needs.deploy-backend.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' || 'Not triggered' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Deploy:** ${{ needs.deploy-frontend.result == 'success' && 'âœ… Success' || needs.deploy-frontend.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' || 'Not triggered' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        BACKEND_DEPLOY_STATUS="${{ needs.deploy-backend.result }}"
        FRONTEND_DEPLOY_STATUS="${{ needs.deploy-frontend.result }}"
        
        if [ "$BACKEND_DEPLOY_STATUS" == "success" ] || [ "$FRONTEND_DEPLOY_STATUS" == "success" ]; then
          echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          if [ "$BACKEND_DEPLOY_STATUS" == "success" ]; then
            echo "- âœ… Backend deployed successfully" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$FRONTEND_DEPLOY_STATUS" == "success" ]; then
            echo "- âœ… Frontend deployed successfully" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your changes have been deployed to the Kubernetes cluster." >> $GITHUB_STEP_SUMMARY
        elif [ "$BACKEND_DEPLOY_STATUS" == "skipped" ] && [ "$FRONTEND_DEPLOY_STATUS" == "skipped" ]; then
          echo "### â„¹ï¸ Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "Images built successfully but deployment was skipped (no changes detected or not on main branch)." >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ Partial Deployment" >> $GITHUB_STEP_SUMMARY
          if [ "$BACKEND_DEPLOY_STATUS" != "success" ] && [ "$BACKEND_DEPLOY_STATUS" != "skipped" ]; then
            echo "- âŒ Backend deployment failed or was not triggered" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$FRONTEND_DEPLOY_STATUS" != "success" ] && [ "$FRONTEND_DEPLOY_STATUS" != "skipped" ]; then
            echo "- âŒ Frontend deployment failed or was not triggered" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
        fi

